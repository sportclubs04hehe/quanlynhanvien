<div class="container-fluid">
  <div class="card shadow-sm">
    <div class="card-body">
      <!-- Toolbar -->
      <div class="d-flex align-items-center gap-2 mb-3">
        @if (pendingCount() > 0) {
          <div class="alert alert-warning mb-0 py-2 px-3 d-inline-flex align-items-center">
            <i class="bi bi-exclamation-circle me-2"></i>
            <strong>{{ pendingCount() }} đơn chờ duyệt</strong>
          </div>
        }
        <button 
          class="btn btn-outline-primary btn-sm"
          (click)="refresh()"
          [disabled]="isLoading()">
          <i class="bi bi-arrow-clockwise me-1"></i>Làm Mới
        </button>
      </div>

      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          {{ errorMessage() }}
          <button type="button" class="btn-close" (click)="errorMessage.set(null)"></button>
        </div>
      }

      <!-- Dons Table -->
      @if (isLoading()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
          </div>
          <p class="mt-3 text-muted">Đang tải danh sách đơn cần duyệt...</p>
        </div>
      } @else if (dons().length > 0) {
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 7%;">Mã Đơn</th>
                <th style="width: 15%;">Nhân Viên</th>
                <th style="width: 10%;">Loại Đơn</th>
                <th style="width: 18%;">Chi Tiết</th>
                <th style="width: 18%;">Lý Do</th>
                <th style="width: 8%;">Ngày Tạo</th>
                <th style="width: 9%;">Trạng Thái</th>
                <th style="width: 15%;" class="text-center">Thao Tác</th>
              </tr>
            </thead>
            <tbody>
              @for (don of dons(); track don.id; let idx = $index) {
                <tr [class.table-warning]="don.trangThai === TrangThaiDon.DangChoDuyet">
                  <td>
                    <span class="badge text-dark">{{ don.maDon }}</span>
                  </td>
                  
                  <!-- Nhân viên info -->
                  <td>
                    <div class="d-flex flex-column">
                      <span class="fw-semibold">{{ don.tenNhanVien }}</span>
                      @if (don.phongBan) {
                        <small class="text-muted">
                          <i class="bi bi-building"></i> {{ don.phongBan.tenPhongBan }}
                        </small>
                      }
                      @if (don.chucVu) {
                        <small class="text-muted">
                          <i class="bi bi-person-badge"></i> {{ don.chucVu.tenChucVu }}
                        </small>
                      }
                    </div>
                  </td>
                  
                  <!-- Loại đơn -->
                  <td>
                    <span class="badge" [ngClass]="getLoaiDonBadgeClass(don.loaiDon)">
                      <i class="bi bi-file-earmark-text me-1"></i>
                      {{ don.loaiDonText }}
                    </span>
                  </td>
                  
                  <!-- Chi tiết -->
                  <td>
                    <div class="detail-info fw-bold">
                      @if (don.loaiDon === LoaiDonYeuCau.NghiPhep) {
                        <!-- Nghỉ Phép -->
                        @if (don.loaiNghiPhepText) {
                          <div class="mb-1">
                            <span class="badge bg-info text-white">{{ don.loaiNghiPhepText }}</span>
                          </div>
                        }
                        @if (don.ngayBatDau) {
                          <small class="text-muted d-block">
                            <i class="bi bi-calendar-check"></i>
                            {{ don.ngayBatDau | localDate:'shortDate' }}
                            @if (don.loaiNghiPhep === 'NhieuNgay' && don.ngayKetThuc) {
                              - {{ don.ngayKetThuc | localDate:'shortDate' }}
                            }
                          </small>
                        }
                        @if (don.soNgayThucTe) {
                          <small class="text-muted d-block">
                            <i class="bi bi-clock"></i>
                            @if (don.soNgayThucTe === 0.5) {
                              Nửa ngày
                            } @else {
                              {{ don.soNgayThucTe }} ngày
                            }
                          </small>
                        }
                      } @else if (don.loaiDon === LoaiDonYeuCau.LamThemGio) {
                        <!-- Làm Thêm Giờ -->
                        @if (don.ngayLamThem) {
                          <small class="text-muted d-block">
                            <i class="bi bi-calendar-check"></i>
                            {{ don.ngayLamThem | localDate:'shortDate' }}
                          </small>
                        }
                        @if (don.soGioLamThem) {
                          <small class="text-muted d-block">
                            <i class="bi bi-clock"></i>
                            {{ don.soGioLamThem }} giờ
                          </small>
                        }
                      } @else if (don.loaiDon === LoaiDonYeuCau.DiMuon) {
                        <!-- Đi Muộn -->
                        @if (don.ngayDiMuon) {
                          <small class="text-muted d-block">
                            <i class="bi bi-calendar-check"></i>
                            {{ don.ngayDiMuon | localDate:'shortDate' }}
                          </small>
                        }
                        @if (don.gioDuKienDen) {
                          <small class="text-muted d-block">
                            <i class="bi bi-clock"></i>
                            Đến: {{ don.gioDuKienDen | localDate:'shortTime' }}
                          </small>
                        }
                      } @else if (don.loaiDon === LoaiDonYeuCau.CongTac) {
                        <!-- Công Tác -->
                        @if (don.ngayBatDau) {
                          <small class="text-muted d-block">
                            <i class="bi bi-calendar-check"></i>
                            {{ don.ngayBatDau | localDate:'shortDate' }}
                            @if (don.ngayKetThuc && don.ngayBatDau !== don.ngayKetThuc) {
                              - {{ don.ngayKetThuc | localDate:'shortDate' }}
                            }
                          </small>
                        }
                        @if (don.diaDiemCongTac) {
                          <small class="text-muted d-block text-truncate" style="max-width: 150px;" [title]="don.diaDiemCongTac">
                            <i class="bi bi-geo-alt"></i>
                            {{ don.diaDiemCongTac }}
                          </small>
                        }
                      }
                    </div>
                  </td>
                  
                  <!-- Lý do -->
                  <td>
                    <span class="text-truncate d-inline-block" style="max-width: 250px;" [title]="don.lyDo">
                      {{ don.lyDo }}
                    </span>
                  </td>
                  
                  <!-- Ngày tạo -->
                  <td>
                    <small class="text-muted">
                      {{ don.ngayTao | localDate: 'dd/MM/yyyy' }}
                    </small>
                  </td>
                  
                  <!-- Trạng thái -->
                  <td>
                    <app-don-status-badge [trangThai]="don.trangThai" />
                  </td>
                  
                  <!-- Actions -->
                  <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                      <!-- View Detail -->
                      <button 
                        class="btn btn-outline-info"
                        (click)="viewDetail(don)"
                        title="Xem chi tiết">
                        <i class="bi bi-eye"></i>
                      </button>
                      
                      <!-- Approve - chỉ hiển thị nếu đang chờ duyệt -->
                      @if (don.trangThai === TrangThaiDon.DangChoDuyet) {
                        <button 
                          class="btn btn-outline-success"
                          (click)="approveDon(don)"
                          title="Chấp thuận">
                          <i class="bi bi-check-circle"></i>
                        </button>
                        
                        <button 
                          class="btn btn-outline-danger"
                          (click)="rejectDon(don)"
                          title="Từ chối">
                          <i class="bi bi-x-circle"></i>
                        </button>
                      }
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        @if (totalPages() > 1) {
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
              Hiển thị {{ (pageNumber() - 1) * pageSize() + 1 }} - 
              {{ Math.min(pageNumber() * pageSize(), totalCount()) }} 
              trong tổng số {{ totalCount() }} đơn
            </div>
            <ngb-pagination 
              [collectionSize]="totalCount()"
              [(page)]="pageNumber"
              [pageSize]="pageSize()"
              [maxSize]="5"
              [rotate]="true"
              [boundaryLinks]="true"
              (pageChange)="onPageChange($event)">
            </ngb-pagination>
          </div>
        }
      } @else {
        <div class="text-center py-5">
          <i class="bi bi-clipboard-check display-1 text-success"></i>
          <p class="mt-3 text-muted fs-5">
            Không có đơn nào cần duyệt
          </p>
          <p class="text-muted">
            Tất cả đơn yêu cầu đã được xử lý
          </p>
        </div>
      }
    </div>
  </div>
</div>
